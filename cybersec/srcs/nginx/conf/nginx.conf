worker_processes auto;

load_module modules/ngx_http_modsecurity_module.so;

events { worker_connections 1024; }

http {
  include       mime.types;
  sendfile      on;
  server_tokens off;

  # --- SSL ---
  map $http_upgrade $connection_upgrade { default upgrade; '' close; }

  upstream app_backend { server backend:3000; }
  upstream app_ws      { server websocket-pong:8081; }
  upstream app_php     { server php-fpm:9000; }
  # If you serve your SPA via app-nginx, uncomment this and change routes to use it.
  # upstream app_front   { server app-nginx:80; }

  server {
    listen 443 ssl;
    server_name localhost;

    ssl_certificate     /etc/nginx/certs/selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/selfsigned.key;

    # Serve SPA static files
    root /usr/share/nginx/html;
    index index.html;

    # --- ModSecurity WAF ---
    modsecurity on;
    modsecurity_rules_file /opt/ModSecurity/modsecurity.conf;

    # --- Security headers (basic sane defaults) ---
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header Referrer-Policy strict-origin-when-cross-origin;

    # ---- FRONTEND ROUTING (SPA) ----
    location / {
      try_files $uri $uri/ /index.html;
    }

    # OPTION B: if your SPA is served by app-nginx, switch to this block
    # location / {
    #   proxy_pass http://app_front;
    #   proxy_set_header Host $host;
    #   proxy_set_header X-Forwarded-Proto https;
    # }

    # ---- API ----
    location /api/ {
      proxy_pass http://app_backend;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto https;
    }

    # ---- AUTH (PHP from cybersec) ----
    # Static files under /auth/ (HTML, JS, CSS) are in /var/www/html
    location ^~ /auth/ {
      root /var/www/html;
      index index.html index.php;
      try_files $uri $uri/ @auth_php;
    }

    location @auth_php {
      # send *.php under /auth/ to php-fpm
      rewrite ^/auth/(.*)$ /$1 break;
      include fastcgi_params;
      fastcgi_param SCRIPT_FILENAME /var/www/html/$fastcgi_script_name;
      fastcgi_param DOCUMENT_ROOT /var/www/html;
      fastcgi_pass app_php;
    }

    location ~ \.php$ {
      # Safety: only allow PHP execution under /auth/
      return 404;
    }

    # ---- WEBSOCKET (WSS) ----
    location /ws/ {
      proxy_pass http://app_ws;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header Host $host;
    }

    # ---- Large bodies & timeouts (tune as needed) ----
    client_max_body_size 10m;
    proxy_read_timeout  60s;
    proxy_send_timeout  60s;
  }
}
